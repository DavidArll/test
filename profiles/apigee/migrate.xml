<?xml version="1.0"?>
<project name="apigee-distro-tasks" default="migrate-to-pantheon" description="Apigee Distro Tasks">
	<!--
	Jenkins jobs for importing site from old apigee hosting to pantheon.
	INPUTS:
			$orgname = Apigee orgname
			$environment = Apigee Envrionment
			$pantheon-alias = Already created pantheon instance to which the user below has access
			$pantheon-email/$pantheon-password = Credentials to update pantheon aliases locally

			~/.s3cfg - for access to the buckets
-->
	<taskdef name="drush" classname="lib.Phing.tasks.drush.DrushTask"/>
	<property name="site-archive-store" value="s3://apigee-devconnect/site-archives"/>
	<property prefix="s3cfg" file="${user.home}/.s3cfg"/>
	<property name="mysql-connect" value="CONNECTION_STRING"/>
	<property name="skip-entity-reference" value="no" override="false" />
	<property name="archive-unpacked" value="${project.basedir}/${env.BUILD_ID}/archive" override="false" />
	<taskdef name="printglobals" classname="lib.Phing.tasks.PrintGlobals"/>
	<!-- -->
	<target name="preflight">
		<property name="orgname" value="${orgname}" override="false" />
		<property name="environment" value="${environment}" override="false" />
		<property name="pantheon-email" value="${pantheon-email}" override="false" />
		<property name="pantheon-password" value="${pantheon-password}" override="false" />
		<property name="production-source" value="${production-source}" override="false" />

		<fail unless="orgname" message="You must set the apigee in-house orgname"/>
		<fail unless="environment" message="You must set the Apigee environment from which to pull an orgname"/>
		<fail unless="pantheon-email" message="You must enter a valid Pantheon account email address"/>
		<fail unless="pantheon-password" message="You must enter a valid Pantheon account password"/>
	</target>
	<!-- -->
	<target name="init-reset" depends="preflight">
		<property name="archive-filename" value="${environment}-${orgname}.tgz"/>
		<delete file="/tmp/${archive-filename}" quiet="true" includeemptydirs="true"/>
		<delete dir="${user.home}/.drush/terminus" quiet="true" includeemptydirs="true"/>
	</target>
	<!-- -->
	<target name="drush-pantheon-config" depends="init-reset">
		<exec command="sudo composer self-update" logoutput="true" />
		<exec command="git clone git@github.com:pantheon-systems/terminus" dir="${user.home}/.drush" logoutput="true" />
		<exec command="composer update"  dir="${user.home}/.drush/terminus" logoutput="true"/>
		<drush command="cc" assume="yes">
			<param>drush</param>
		</drush>
		<drush command="pantheon-auth" assume="yes">
			<option name="password">"${pantheon-password}"</option>
			<param>${pantheon-email}</param>
		</drush>
		<trycatch>
			<try>
				<exec command="drush pantheon-aliases -y"/>
			</try>
			<catch>
				<exec command="drush pantheon-aliases -y"/>
			</catch>
		</trycatch>
		<drush command="dl" assume="yes">
			<param>registry_rebuild</param>
		</drush>
		<drush command="cc" assume="yes">
			<param>drush</param>
		</drush>
	</target>
	<!-- -->
	<target name="migrate-to-pantheon" depends="drush-pantheon-config">
		<property name="pantheon-alias" value="@${orgname}.dev" override="false" />
		<property name="site-alias" value="${pantheon-alias}" />
		<property name="old-hosting-sites-folder" value="sites/${environment}-${orgname}" />
		<property name="archive-filename" value="${environment}-${orgname}.tgz"/>
		<php expression="str_replace(array('.dev', '.live', '.test', '@'), '', '${pantheon-alias}');" returnProperty="pantheon-sitename" />
		<drush command="psite-uuid" assume="yes" returnProperty="pantheon-uuid">
			<param>${pantheon-sitename}</param>
		</drush>
		<property name="pantheon-uuid" value="${pantheon-uuid}" />
		<php expression="str_replace('${pantheon-sitename}: ', '', '${pantheon-uuid}');" returnProperty="pantheon-uuid" />
		<php expression="substr_count('${pantheon-uuid}', '-');" returnProperty="uuid-valid" />
		<if>
			<not>
				<equals arg1="${uuid-valid}" arg2="4" />
			</not>
			<then>
				<phingcall target="display-step">
					<param name="message" value="====: Creating new site :====" />
				</phingcall>
				<drush command="psite-create" assume="yes" verbose="yes">
					<option name="organization">cb6b74dc-c0a7-4b9a-a1eb-309155c7476a</option>
					<option name="product">7ce141f4-c1b2-439b-a0ad-fc90363ece1e</option>
					<option name="label">${pantheon-sitename}</option>
					<param>${pantheon-sitename}</param>
				</drush>
				<trycatch>
					<try>
						<drush command="pantheon-aliases" assume="yes" />
					</try>
					<catch>
						<phingcall target="display-step">
							<param name="message" value="Aliases could not be fetched. Pantheon terminus server could be timing out..." />
						</phingcall>
					</catch>
				</trycatch>
				<drush command="psite-uuid" assume="yes" returnProperty="pantheon-uuid">
					<param>${pantheon-sitename}</param>
				</drush>
				<property name="pantheon-uuid" value="${pantheon-uuid}" />
				<property name='apigee-restore-necessary' value="NO" />
			</then>
			<else>
				<phingcall target="display-step">
					<param name="message" value="====: Backing up the development environment :====" />
				</phingcall>
				<exec command="drush psite-backup ${pantheon-uuid} dev" logoutput="true"/>
				<property name='apigee-restore-necessary' value="YES" />
			</else>
		</if>
		<trycatch>
			<try>
				<drush command="psite-team-add" assume="yes">
					<param>${pantheon-uuid}</param>
					<param>${pantheon-email}</param>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Can't add ${pantheon-email}" />
				</phingcall>
			</catch>
		</trycatch>
		<trycatch>
			<try>
				<drush command="psite-team-add" assume="yes">
					<param>${pantheon-uuid}</param>
					<param>djohnson@apigee.com</param>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Can't add djohnson@apigee.com" />
				</phingcall>
			</catch>
		</trycatch>
		<trycatch>
			<try>
				<drush command="psite-team-add" assume="yes">
					<param>${pantheon-uuid}</param>
					<param>seshireddy@apigee.com</param>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Can't add seshireddy@apigee.com" />
				</phingcall>
			</catch>
		</trycatch>
		<trycatch>
			<try>
				<drush command="psite-team-add" assume="yes">
					<param>${pantheon-uuid}</param>
					<param>bhasselbeck@apigee.com</param>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Can't add bhasselbeck@apigee.com" />
				</phingcall>
			</catch>
		</trycatch>
		<phingcall target="display-step">
			<param name="message" value="====: CONNECTING TO MYSQL (drush ${site-alias} sql-connect) :====" />
		</phingcall>
		<exec command="drush ${site-alias} sql-connect -y" outputProperty="mysql-connect" logoutput="true" />
		<phingcall target="display-step">
			<param name="message" value="====: BEGINNING MIGRATION OF ${orgname} to ${pantheon-alias} (uuid: ${pantheon-uuid}) :====" />
		</phingcall>
		<drush command="site-alias" assume="yes" returnProperty="remote-host">
			<option name="component">remote-host</option>
			<param>${site-alias}</param>
		</drush>
		<property name="remote-host" value="${remote-host}" />
		<phingcall target="display-step">
			<param name="message" value="Remote host set: ${remote-host}" />
		</phingcall>
		<drush command="site-alias" assume="yes" returnProperty="remote-user">
			<option name="component">remote-user</option>
			<param>${site-alias}</param>
		</drush>
		<property name="remote-user" value="${remote-user}" />
		<phingcall target="display-step">
			<param name="message" value="Remote user set: ${remote-user}" />
		</phingcall>
		<drush command="psite-cmode" assume="yes">
			<param>"${pantheon-uuid}"</param>
			<param>dev</param>
			<param>SFTP</param>
		</drush>
		<s3get key="${s3cfg.access_key}" secret="${s3cfg.secret_key}" bucket="apigee-devconnect" object="site-archives/${archive-filename}" target="/tmp/${archive-filename}" />
		<mkdir dir="${project.basedir}/${env.BUILD_ID}" />
		<untar file="/tmp/${archive-filename}" todir="${archive-unpacked}"/>
		<property prefix="inifile" file="${archive-unpacked}/MANIFEST.ini" />
		<php function="str_replace" returnProperty="database-default-file">
			<param value='"' />
			<param value="" />
			<param value="${inifile.database-default-file}" />
		</php>
		<php function="str_replace" returnProperty="files-public">
			<param value='"' />
			<param value="" />
			<param value="${inifile.files-public}" />
		</php>
		<php function="str_replace" returnProperty="archive-sitedir">
			<param value='"' />
			<param value="" />
			<param value="${inifile.sitedir}" />
		</php>
		<trycatch property="foo1">
			<try>
				<phingcall target="rsync-command">
					<property name="source" value="${project.basedir}/apigee.drush.inc" />
					<property name="destination" value="${remote-user}@${remote-host}:.drush" />
				</phingcall>
				<drush alias="${site-alias}" command="cc">
					<param>drush</param>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Failed to update drush command on remote" />
				</phingcall>
			</catch>
		</trycatch>
		<if>
			<equals arg1="${apigee-restore-necessary}" arg2="YES" />
			<then>
				<trycatch property="foo2">
					<try>
						<phingcall target="display-step">
							<param name="message" value="Dropping current db tables" />
						</phingcall>
						<drush alias="${site-alias}" command="apigee-restore" />
					</try>
					<catch>
						<fail message="Unable to drop tables on db" />
					</catch>
				</trycatch>
			</then>
		</if>
		<trycatch property="foo3">
			<try>
				<phingcall target="display-step">
					<param name="message" value="Restoring Database from SQL file: ${mysql-connect} &lt; '${archive-unpacked}/${database-default-file}' " />
				</phingcall>
				<exec command="${mysql-connect} &lt; '${archive-unpacked}/${database-default-file}'" logoutput="true" passthru="false" />
			</try>
			<catch>
				<fail message="Database command failed. Database was not restored." />
			</catch>
		</trycatch>
		<phingcall target="database-truncate">
			<property name="tablename" value="cache" />
			<property name="site-alias" value="${site-alias}" />
		</phingcall>
		<phingcall target="database-truncate">
			<property name="tablename" value="cache_bootstrap" />
			<property name="site-alias" value="${site-alias}" />
		</phingcall>
		<phingcall target="database-truncate">
			<property name="tablename" value="facet" />
			<property name="site-alias" value="${site-alias}" />
		</phingcall>
		<phingcall target="database-truncate">
			<property name="tablename" value="registry" />
			<property name="site-alias" value="${site-alias}" />
		</phingcall>
		<phingcall target="database-truncate">
			<property name="tablename" value="registry_file" />
			<property name="site-alias" value="${site-alias}" />
		</phingcall>
		<phingcall target="drop-tables">
			<property name="tablename" value="apachesolr" />
		</phingcall>
		<phingcall target="drop-tables">
			<property name="tablename" value="rules" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set filename=REPLACE(filename, 'sites/all/modules', 'profiles/apigee/modules') where filename like 'sites/all/modules%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set filename=REPLACE(filename, 'sites/all/themes', 'profiles/apigee/themes') where filename like 'sites/all/themes%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set filename=REPLACE(filename, 'sites/all/themes', 'profiles/apigee/themes') where filename like 'sites/all/themes%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update registry set filename=REPLACE(filename, 'sites/all/modules', 'profiles/apigee/modules') where filename like 'sites/all/modules%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="delete from system where name like '%Rules%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update block_custom set body=replace(body, '/sites/all/themes/apigee_base', '/profiles/apigee/themes/apigee_base')" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update block_custom set body=replace(body, '/sites/all/themes/apigee_devconnect', '/profiles/apigee/themes/apigee_devconnect');" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update menu_router set include_file=replace(include_file, 'sites/all/modules/contrib', 'profiles/apigee/modules/contrib');" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update menu_router set include_file=replace(include_file, 'sites/all/modules/custom', 'profiles/apigee/modules/custom');" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set weight=-10 where filename like '%view%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set status=0 where name like '%apachesolr%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set status=0 where name like '%rules%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set status=0 where name like '%facet%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set schema_version=-1 where name like '%apachesolr%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="update system set schema_version=-1 where name like '%rules%';" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="delete from variable where name like 'apachesolr%'" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="query" value="drop table if exists temp_og_users_roles;" />
		</phingcall>
		<phingcall target="mysql-query-string">
			<property name="apigee_install_profile" value='s:6:"apigee";'/>
			<property name="query" value="REPLACE INTO variable (name, value) VALUES ('install_profile', '${apigee_install_profile}');" />
		</phingcall>
		<phingcall target="display-step">
			<param name="message" value="Rebuilding the registry" />
		</phingcall>
		<trycatch>
			<try>
				<exec command="drush ${site-alias} rr" logoutput="true"/>
				<exec command="drush ${site-alias} updb -y" logoutput="true"/>
				<phingcall target="display-step">
					<param name="message" value="Attempt #1: Database Updates Successfully Occurred" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Attempt #1: Database Updates failed" />
				</phingcall>
			</catch>
		</trycatch>
		<trycatch>
			<try>
				<exec command="drush ${site-alias} rr" logoutput="true"/>
				<exec command="drush ${site-alias} updb -y" logoutput="true"/>
				<phingcall target="display-step">
					<param name="message" value="Attempt #2: Database Updates Successfully Occurred" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="Attempt #2: Database Updates failed Again" />
				</phingcall>
			</catch>
		</trycatch>
		<!-- Completes the mysql portion of the build, then it takes the new code and rebuilds the registry and updates the code -->
		<phingcall target="display-step">
			<param name="message" value="STARTING MIGRATION SPECIFIC TASKS" />
		</phingcall>
		<trycatch property="foo7">
			<try>
				<phingcall target="migration-fixes">
					<property name="site-alias" value="${site-alias}" />
					<property name="remote-host" value="${remote-host}" />
					<property name="remote-user" value="${remote-user}" />
					<property name="archive-sitedir" value="${archive-sitedir}" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="MIGRATION FIXES COULD NOT BE MADE" />
				</phingcall>
			</catch>
		</trycatch>
		<phingcall target="display-step">
			<param name="message" value="SETTING VARIABLES" />
		</phingcall>
		<drush alias="${site-alias}" command="vset">
			<param>install_profile</param>
			<param>apigee</param>
		</drush>
		<drush alias="${site-alias}" command="vset">
			<param>migration_occurred</param>
			<param>1</param>
		</drush>
		<drush alias="${site-alias}" command="apigee-environment" returnProperty="file_public_path">
			<param>file_public_path</param>
		</drush>
		<drush alias="${site-alias}" command="vset" assume="yes" >
			<param>file_public_path</param>
			<param>"${file_public_path}"</param>
		</drush>
		<drush alias="${site-alias}" command="apigee-environment" returnProperty="file_private_path" >
			<param>file_private_path</param>
		</drush>
		<drush alias="${site-alias}" command="vset" assume="yes" >
			<param>file_private_path</param>
			<param>"${file_private_path}"</param>
		</drush>
		<drush alias="${site-alias}" command="apigee-environment" returnProperty="file_temporary_path">
			<param>file_temporary_path</param>
		</drush>
		<drush alias="${site-alias}" command="vset" assume="yes" >
			<param>file_temporary_path</param>
			<param>"${file_temporary_path}"</param>
		</drush>
		<drush alias="${site-alias}" command="vset" assume="yes">
			<param>preprocess_js</param>
			<param>"0"</param>
		</drush>
		<drush alias="${site-alias}" command="vset" assume="yes">
			<param>preprocess_css</param>
			<param>"0"</param>
		</drush>
		<phingcall target="display-step">
			<param name="message" value="RSYNCING CODE" />
		</phingcall>
		<!-- get any files not managed by drupal. Check both clusters and fail silently if nonexistant -->
		<exec command="s3cmd sync --recursive s3://apigee-devconnect/rea1dc001/${environment}-${orgname}/files ." dir="${archive-unpacked}/devconnect-111.8/${archive-sitedir}" passthru="true" logoutput="true" checkreturn="false" />
		<exec command="s3cmd sync --recursive s3://apigee-devconnect/rea1dc002/${environment}-${orgname}/files ." dir="${archive-unpacked}/devconnect-111.8/${archive-sitedir}" passthru="true" logoutput="true" checkreturn="false" />
		<!-- Delete CSS/JS Aggregation -->
		<phingcall target="display-step">
			<param name="message" value="DELETING AGGREGATION" />
		</phingcall>
		<delete quiet="true">
			<fileset dir="${archive-unpacked}/devconnect-111.8/${files-public}">
				<include name="js/**" />
				<include name="css/**" />
				<include name="cdn/**" />
				<include name="ctools/**" />
			</fileset>
		</delete>
		<phingcall target="display-step">
			<param name="message" value="RSYNCING FILES, MODULES, LIBRARIES, and THEMES" />
		</phingcall>
		<phingcall target="rsync-command">
			<property name="source" value="${archive-unpacked}/devconnect-111.8/${files-public}" />
			<property name="destination" value="${remote-user}@${remote-host}:~/." />
		</phingcall>
		<phingcall target="rsync-command">
			<property name="source" value="${archive-unpacked}/devconnect-111.8/${archive-sitedir}/modules" />
			<property name="destination" value="${remote-user}@${remote-host}:code/sites/all" />
		</phingcall>
		<phingcall target="rsync-command">
			<property name="source" value="${archive-unpacked}/devconnect-111.8/${archive-sitedir}/libraries" />
			<property name="destination" value="${remote-user}@${remote-host}:code/sites/all" />
		</phingcall>
		<phingcall target="rsync-command">
			<property name="source" value="${archive-unpacked}/devconnect-111.8/${archive-sitedir}/themes" />
			<property name="destination" value="${remote-user}@${remote-host}:code/sites/all" />
		</phingcall>
		<exec command="drush ${site-alias} updb -y"/>
		<exec command="drush ${site-alias} rr" logoutput="true"/>
		<trycatch>
			<try>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_style.inc' where name = 'references_plugin_style';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_display.inc' where name = 'references_plugin_display';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_handler_argument.inc' where name = 'references_handler_argument';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_row_fields.inc' where name = 'references_plugin_row_fields';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_handler_relationship.inc' where name = 'references_handler_relationship';" />
				</phingcall>
				<phingcall target="display-step">
					<param name="message" value="UPDATED REFERENCE REGISTRY" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="COULDN'T UPDATE REFERENCE REGISTRY" />
				</phingcall>
			</catch>
		</trycatch>
		<phingcall target="display-step">
			<param name="message" value="ENABLING JIRA ISSUE COLLECTOR" />
		</phingcall>
		<trycatch property="foo5">
			<try>
				<drush alias="${site-alias}" command="dl" assume="yes">
					<param>jira_issue_collector</param>
				</drush>
				<exec command="drush ${site-alias} pm-enable jira_issue_collector -y" logoutput="true"/>
				<drush alias="${site-alias}" command="vset" assume="yes">
					<param>jira_issue_collector_code</param>
					<param><![CDATA['<script type="text/javascript" src="https://apigeesc.atlassian.net/s/d41d8cd98f00b204e9800998ecf8427e/en_US-nfwzef-1988229788/6144/98/1.4.0-m6/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=140f6a91"></script>']]></param>
				</drush>
				<drush alias="${site-alias}" command="vset" assume="yes">
					<param>jira_issue_collector_url</param>
					<param>"https://apigeesc.atlassian.net/s/d41d8cd98f00b204e9800998ecf8427e/en_US-nfwzef-1988229788/6144/98/1.4.0-m6/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?collectorId=140f6a91"</param>
				</drush>
				<php expression="json_encode(array(1 => 1, 2 => 2, 5 => 5, 3 => 3));" returnProperty="json-array" />
				<drush alias="${site-alias}" command="vset" assume="yes">
					<param>jira_issue_collector_roles</param>
					<param>'${json-array}'</param>
					<option name="format">json</option>
				</drush>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="JIRA ISSUE COLLECTOR COULD NOT BE DOWNLOADED" />
				</phingcall>
			</catch>
		</trycatch>
		<phingcall target="display-step">
			<param name="message" value="FINALIZING and ENSURING MODULE TASKS" />
		</phingcall>
		<phingcall target="display-step">
			<param name="message" value="DISABLING MODULES" />
		</phingcall>
		<exec command="drush ${site-alias} pm-disable variable -y" logoutput="true" />
		<exec command="drush ${site-alias} pm-disable block_class -y" logoutput="true"  />
		<exec command="drush ${site-alias} pm-disable smtp cdn -y" logoutput="true" />
		<!-- R24 error, need to enable new module -->
		<phingcall target="display-step">
			<param name="message" value="ENABLING MODULES" />
		</phingcall>
		<exec command="drush ${site-alias} en libraries -y" logoutput="true"/>
		<exec command="drush ${site-alias} en d8cmi -y" logoutput="true" />
		<exec command="drush ${site-alias} en bean -y" logoutput="true" />
		<exec command="drush ${site-alias} en block_class -y" logoutput="true" />
		<exec command="drush ${site-alias} en apachesolr -y" logoutput="true" />
		<exec command="drush ${site-alias} en apachesolr_search -y" logoutput="true" />
		<exec command="drush ${site-alias} en pantheon_api -y" logoutput="true" />
		<exec command="drush ${site-alias} en pantheon_apachesolr -y" logoutput="true" />
		<exec command="drush ${site-alias} en apigee_account  -y" logoutput="true" />
		<exec command="drush ${site-alias} en devconnect_migration -y" logoutput="true"/>
		<exec command="drush ${site-alias} rr" logoutput="true" />
		<exec command="drush ${site-alias} cc all" logoutput="true" />
		<exec command="drush ${site-alias} updb -y" logoutput="true" />
		<phingcall target="display-step">
			<param name="message" value="ENTITY MIGRATION TASKS" />
		</phingcall>
		<if>
			<equals arg1="${skip-entity-reference}" arg2="no" />
			<then>
				<drush alias="${site-alias}" command="dl" assume="yes">
					<param>entityreference_migration</param>
				</drush>
				<drush alias="${site-alias}" command="pm-enable" assume="yes">
					<param>entityreference_migration</param>
				</drush>

				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_style.inc' where name = 'references_plugin_style';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_display.inc' where name = 'references_plugin_display';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_handler_argument.inc' where name = 'references_handler_argument';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_plugin_row_fields.inc' where name = 'references_plugin_row_fields';" />
				</phingcall>
				<phingcall target="mysql-query-string">
					<property name="query" value="update registry set filename='sites/all/modules/contrib/references/views/references_handler_relationship.inc' where name = 'references_handler_relationship';" />
				</phingcall>

				<drush alias="${site-alias}" command="entityreference-migrate-references" assume="yes" />
				<drush alias="${site-alias}" command="pm-disable" assume="yes">
					<param>entityreference_migration</param>
					<param>references</param>
					<param>node_reference</param>
				</drush>
				<drush alias="${site-alias}" command="pm-uninstall" assume="yes">
					<param>entityreference_migration</param>
					<param>references</param>
					<param>node_reference</param>
				</drush>
			</then>
		</if>
		<phingcall target="display-step">
			<param name="message" value="VIEWS TEMPLATE TASKS" />
		</phingcall>
		<trycatch property="foo8">
			<try>
				<phingcall target="views-template">
					<property name="site-alias" value="${site-alias}" />
					<property name="remote-host" value="${remote-host}" />
					<property name="remote-user" value="${remote-user}" />
					<property name="archive-sitedir" value="${archive-sitedir}" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="COULD NOT MAKE VIEWS TEMPLATE" />
				</phingcall>
			</catch>
		</trycatch>
		<exec command="drush ${site-alias} cc all" logoutput="true"/>
		<phingcall target="display-step">
			<param name="message" value="ATTEMPTING TO COMMIT CHANGES AND TURN BACK TO GIT" />
		</phingcall>
		<trycatch property="foo9">
			<try>
				<property name="VERSION" value="pantheon-4.24.${env.BUILD_NUMBER}"/>
				<drush command="psite-commit" assume="yes">
					<param>"${pantheon-uuid}"</param>
					<param>--message="distro migration ${VERSION}"</param>
				</drush>
				<drush command="psite-cmode" assume="yes">
					<param>"${pantheon-uuid}"</param>
					<param>dev</param>
					<param>GIT</param>
				</drush>
				<phingcall target="display-step">
					<param name="message" value="ATTEMPT TO COMMIT CHANGES WAS SUCCESSFUL" />
				</phingcall>
			</try>
			<catch>
				<phingcall target="display-step">
					<param name="message" value="ATTEMPT TO COMMIT CHANGES FAILED" />
				</phingcall>
			</catch>
		</trycatch>
		<exec command="drush ${site-alias} en devconnect_migration -y" logoutput="true"/>
		<!-- enable themes -->
		<exec command="drush ${site-alias} vget theme_default --format=json -y" returnProperty="theme-default" logoutput="true"/>
		<php function="str_replace" returnProperty="theme-default-fixed">
			<param value='"' />
			<param value="" />
			<param value="${theme-default}" />
		</php>
		<exec command="drush ${site-alias} pm-enable ${theme-default-fixed} -y" logoutput="true"/>
		<exec command="drush ${site-alias} pm-enable apigee_base -y" logoutput="true"/>
		<exec command="drush ${site-alias} pm-enable apigee_devconnect -y" logoutput="true"/>
		<exec command="drush ${site-alias} pm-enable tao -y" logoutput="true"/>
		<exec command="drush ${site-alias} pm-enable rubik -y" logoutput="true"/>
		<phingcall target="display-step">
			<param name="message" value="FINAL CLEAR CACHE and CLEANING" />
		</phingcall>
		<exec command="drush ${site-alias} rr" logoutput="true"/>
		<exec command="drush ${site-alias} updb -y" logoutput="true"/>
		<exec command="drush ${site-alias} cc all" logoutput="true"/>
		<phingcall target="cleanup" />
	</target>
	<!-- -->
	<target name="drop-tables">
		<property name="tablename" value="apachesolr" override="false" />
		<property name="site-alias" value="@${orgname}.dev" override="false" />

		<drush alias="${site-alias}" command="sql-query" returnProperty="database-table-list">
			<param>"show tables like '%${tablename}%'"</param>
		</drush>
		<property name="database-table-list" value="${database-table-list}" />

		<php expression="implode(',', array_splice(explode(PHP_EOL, '${database-table-list}'), 1))" returnProperty="database-tables" />
		<foreach list="${database-tables}" param="drop-table" target="mysql-query-string" />
	</target>
	<!-- -->
	<target name="migration-fixes">
		<phingcall target="display-step">
			<param name="message" value="CLONING APIGEE DRUPAL MIGRATE REPO" />
		</phingcall>
		<mkdir dir="${archive-unpacked}/devconnect-111.8/sites/all/modules/custom/apigee_migration" />
		<gitclone repository="git@github.com:apigee/apigee-drupal-migrate.git" targetPath="${archive-unpacked}/devconnect-111.8/sites/all/modules/custom/apigee_migration" />
		<delete dir="${archive-unpacked}/devconnect-111.8/sites/all/modules/custom/apigee_migration/.git" quiet="true"/>
		<phingcall target="rsync-command">
			<property name="source" value="${archive-unpacked}/devconnect-111.8/sites/all/modules/custom/apigee_migration" />
			<property name="destination" value="${remote-user}@${remote-host}:code/sites/all/modules/custom"/>
		</phingcall>
	</target>
	<!-- -->
	<target name="database-truncate">
		<property name="tablename" value="cache" override="false" />
		<property name="site-alias" value="@${orgname}.dev" override="false" />

		<drush alias="${site-alias}" command="sql-query" returnProperty="database-table-list">
			<param>"show tables like '%${tablename}%'"</param>
		</drush>

		<php expression="implode(',', array_splice(explode(PHP_EOL, '${database-table-list}'), 1))" returnProperty="database-tables" />
		<foreach list="${database-tables}" param="truncate-table" target="mysql-query-string" />
	</target>
	<!-- -->
	<target name="mysql-query-string">
		<property name="site-alias" value="@${orgname}.dev" override="false" />
		<if>
			<isset property="drop-table" />
			<then>
				<property name="query" value="drop table ${drop-table}"/>
			</then>
		</if>
		<if>
			<isset property="truncate-table" />
			<then>
				<property name="query" value="truncate ${truncate-table}"/>
			</then>
		</if>
		<phingcall target="display-step">
			<param name="message" value="EXECUTING: ${mysql-connect} -e `${query}`" />
		</phingcall>
		<exec command='${mysql-connect} -e "${query}"' logoutput="true" />
	</target>
	<!-- -->
	<target name="rsync-command">
		<phingcall target="display-step">
			<param name="message" value="rsync -rlvz --size-only --exclude='.*' --ipv4 --progress -e 'ssh -p 2222 -oStrictHostKeyChecking=no' '${source}' '${destination}'" />
		</phingcall>
		<exec command="rsync -rlvz --size-only --exclude='.*' --ipv4 --progress -e 'ssh -p 2222 -oStrictHostKeyChecking=no' '${source}' '${destination}'" logoutput="true" />
	</target>
	<!-- -->
	<target name="views-template">
		<drush alias="${site-alias}" command="vget" returnProperty="theme-default">
			<param>theme_default</param>
			<option name="format">json</option>
		</drush>
		<php function="str_replace" returnProperty="theme-default">
			<param value='"' />
			<param value="" />
			<param value="${theme-default}" />
		</php>
		<drush alias="${site-alias}" command="dd" assume="yes" returnProperty="theme-path">
			<param>"${theme-default}"</param>
		</drush>
		<property name="theme-path" value="${theme-path}"/>
		<if>
			<not>
				<contains string="${theme-path}" substring="profiles" />
			</not>
			<then>
				<property name="path" value="${archive-unpacked}/devconnect-111.8/sites/${archive-sitedir}/themes/${theme-default}/templates" />
				<mkdir dir="${path}" />
				<echo file="${path}/views-view-unformatted.tpl.php" append="false" level="verbose"><![CDATA[<?php

/**
 * @file
 * Default simple view template to display a list of rows.
 *
 * @ingroup views_templates
 */
?>
<?php if (!empty($title)): ?>
<h3><?php print $title; ?></h3>
<?php endif; ?>
<?php foreach ($rows as $id => $row): ?>
<div<?php if ($classes_array[$id]) { print ' class="' . $classes_array[$id] .'"';  } ?>>
  <?php print $row; ?>
</div>
<?php endforeach; ?>

    ]]></echo>
				<phingcall target="rsync-command">
					<property name="source" value="${archive-unpacked}/devconnect-111.8/${archive-sitedir}/themes/${theme-default}/templates/views-view-unformatted.tpl.php" />
					<property name="destination" value="${remote-user}@${remote-host}:code/sites/all/themes" />
				</phingcall>
			</then>
		</if>
	</target>
	<!-- -->
	<target name="display-step">
		<echo> </echo>
		<echo> </echo>
		<echo>/** </echo>
		<echo>* -------------------------------------------------</echo>
		<echo>*</echo>
		<echo>* =&gt; ${message}</echo>
		<echo>*</echo>
		<echo>* -------------------------------------------------</echo>
		<echo>*/</echo>
		<echo> </echo>
		<echo> </echo>
	</target>

	<target name="cleanup">
		<delete file="/tmp/${archive-filename}" quiet="true" includeemptydirs="true"/>
		<delete file="${project.basedir}/${env.BUILD_ID}" quiet="true" includeemptydirs="true"/>
	</target>

</project>
