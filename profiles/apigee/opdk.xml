<?xml version="1.0"?>
<project name="apigee-drupal-opdk" default="build-opdk" description="Apigee Drupal Build">
  <!-- 
    
    
    -->
  <property name="DEVTOOLS_IS_INSTALLED" value="false" override="false"/>
  <property name="DISTRO_SOURCE" value="git@github.com:apigee/drupal7-drops" override="false"/>
  <property prefix="s3cfg" file="${user.home}/.s3cfg"/>
  <property name="VERSION" value="14.03.${env.BUILD_NUMBER}"/>
  <!-- 
    
    
    -->
  <target name="clean">
    <delete dir="${project.basedir}/scripts/bundle" quiet="true"/>
    <delete dir="${user.home}/rpmbuild" quiet="true"/>
    <delete dir="/tmp/${env.BUILD_ID}" quiet="true"/>
    <mkdir dir="${project.basedir}/scripts/bundle/devportal-repo"/>
    <mkdir dir="/tmp/${env.BUILD_ID}"/>
  </target>
  <!-- 
    
   	Build RPM for portal distro
	  
    -->
  <target name="build-rpm" depends="clean">
    <exec command="rpm -q rpmdevtools" returnProperty="DEVTOOLS_IS_INSTALLED"/>
    <if>
      <equals arg1="${DEVTOOLS_IS_INSTALLED}" arg2="package rpmdevtools is not installed"/>
      <then>
        <exec command="sudo yum install -y rpmdevtools" logoutput="true"/>
      </then>
    </if>
    <exec command="rpmdev-setuptree"/>
    <copy todir="${user.home}/rpmbuild/SOURCES">
      <fileset dir="${project.basedir}/rpmspec">
        <include name="**/**"/>
      </fileset>
    </copy>
    <copy todir="${user.home}/rpmbuild/SPECS">
      <fileset dir="${project.basedir}/rpmspec">
        <include name="**/**"/>
      </fileset>
    </copy>
    <phingcall target="display-step">
      <property name="message" value="Cloning Current repo: ${DISTRO_SOURCE}"/>
    </phingcall>
    <gitclone repository="${DISTRO_SOURCE}" targetPath="/tmp/${env.BUILD_ID}/apigee-drupal"/>
    <exec command="cat /tmp/${env.BUILD_ID}/apigee-drupal/buildInfo | awk -F'=| ' '/Version/ {print $2}' | cut -d'-' -f2" outputProperty="VERSION" logoutput="true" />
    <phingcall target="display-step">
      <property name="message" value="Setting version number to: ${VERSION}"/>
    </phingcall>
    <tar destfile="${user.home}/rpmbuild/SOURCES/apigee-drupal.tar.gz" compression="gzip" includeemptydirs="true">
      <fileset dir="/tmp/${env.BUILD_ID}">
        <include name="**/**"/>
      </fileset>
    </tar>
    <exec command="rpmbuild --define 'BUILD_NUMBER '$BUILD_NUMBER --define 'VERSION '${VERSION} -ba apigee-drupal.spec" dir="${user.home}/rpmbuild/SPECS" logoutput="true"/>
    <delete>
      <fileset dir="${user.home}/rpmbuild/RPMS/noarch">
        <include name="**/*rpmbuild*"/>
      </fileset>
    </delete>
  </target>
  <!-- 
    
		Build entire package
    
    -->
  <target name="build-opdk" depends="build-rpm">
    <move file="${user.home}/rpmbuild/RPMS/noarch" tofile="${user.home}/rpmbuild/RPMS/DeveloperServices-${VERSION}" overwrite="true"/>
    <copy todir="${user.home}/rpmbuild/RPMS/DeveloperServices-${VERSION}">
      <fileset dir="${project.basedir}/docs">
        <include name="**/*.pdf"/>
        <include name="**/*.rtf"/>
      </fileset>
    </copy>
    <tar destfile="${user.home}/rpmbuild/DeveloperServices-${VERSION}.tar.gz" compression="gzip" includeemptydirs="true" basedir="${user.home}/rpmbuild/RPMS/DeveloperServices-${VERSION}"/>
    <exec command="s3cmd put --progress ${user.home}/rpmbuild/DeveloperServices-${VERSION}.tar.gz s3://apigee-cloudfront/DeveloperServices-${VERSION}.tar.gz" logoutput="true" passthru="true" checkreturn="true"/>
    <phingcall target="display-step">
      <property name="message" value="Uploaded bundle to s3://apigee-cloudfront/DeveloperServices-${VERSION}.tar.gz"/>
    </phingcall>
  </target>
  <!-- 
    
		Messages for debugging and information
    
    -->
  <target name="display-step">
    <echo> </echo>
    <echo> </echo>
    <echo>/** </echo>
    <echo>* -------------------------------------------------</echo>
    <echo>*</echo>
    <echo>* =&gt; ${message}</echo>
    <echo>*</echo>
    <echo>* -------------------------------------------------</echo>
    <echo>*/</echo>
    <echo> </echo>
    <echo> </echo>
  </target>
</project>
